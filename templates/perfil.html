<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äî BANKA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Header com usu√°rio logado -->
    <header class="site-header">
        <div class="container header-inner">
            <div class="brand">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="1" y="1" width="22" height="22" rx="6" fill="#FFD700" />
                    <path d="M7 17L11 7L13 12L17 5" stroke="#6B3410" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="brand-name">BANKA</span>
            </div>
            <nav class="nav nav-dashboard">
                <div class="user-info">
                    <span class="user-badge">üë§ <span id="userName">Usu√°rio</span></span>
                </div>
                <a class="btn btn-outline" href="/add">+ Cadastrar Com√©rcio</a>
                <button class="btn btn-danger" onclick="logout()">Sair</button>
            </nav>
        </div>
    </header>

    <main class="container dashboard-section">
        <!-- Welcome Section -->
        <div class="welcome-banner">
            <div class="welcome-content">
                <h1>Bem-vindo, <span id="userNameBig">Usu√°rio</span>! üëã</h1>
                <p>Confira os com√©rcios e produtos dispon√≠veis na sua regi√£o</p>
            </div>
            <div class="welcome-avatar">
                <div class="avatar-big" id="avatarBig">U</div>
            </div>
        </div>

        <!-- Com√©rcios Section -->
        <section class="comercios-section">
            <div class="section-header">
                <h2>üè™ Com√©rcios Locais</h2>
                <p class="section-subtitle">Descubra os melhores produtores da regi√£o</p>
            </div>

            <div id="comerciosList" class="comercios-grid">
                <div class="loading">Carregando com√©rcios...</div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2024 BANKA ‚Äî Feiras Locais Conectadas. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script src="/static/auth.js"></script>
    <script>
        // Carregar fun√ß√£o getLoggedUser imediatamente
        let pageUser = null;

        // Expor fun√ß√£o logout globalmente
        window.logout = function() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('banka_user');
                localStorage.removeItem('banka_login_time');
                const toast = document.getElementById('toast');
                if (toast) {
                    toast.textContent = '‚úì Logout realizado';
                    toast.className = 'toast toast-success active';
                    setTimeout(() => toast.classList.remove('active'), 2000);
                }
                setTimeout(() => { window.location.href = '/'; }, 1500);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Verificar se usu√°rio est√° logado
            pageUser = getLoggedUser();
            if (!pageUser) {
                window.location.href = '/login';
                return;
            }

            // Preencher dados do usu√°rio
            const userName = pageUser.nome || 'Usu√°rio';
            document.getElementById('userName').textContent = userName;
            document.getElementById('userNameBig').textContent = userName;
            document.getElementById('avatarBig').textContent = userName.charAt(0).toUpperCase();

            // Carregar com√©rcios UMA VEZ
            loadComercios();
        });

        async function loadComercios() {
            try {
                const response = await fetch('/api/comercios');
                const comercios = await response.json();

                const container = document.getElementById('comerciosList');
                container.innerHTML = '';

                if (!comercios || comercios.length === 0) {
                    container.innerHTML = '<p class="empty-state">Nenhum com√©rcio cadastrado ainda. Seja o primeiro!</p>';
                    return;
                }

                comercios.forEach(comercio => {
                    const card = document.createElement('div');
                    card.className = 'comercio-card';
                    
                    const logo = comercio.nome.split(' ').map(p => p[0]).join('').toUpperCase().slice(0, 2);
                    
                    card.innerHTML = `
                        <div class="comercio-logo">${logo}</div>
                        <h3>${comercio.nome}</h3>
                        <p class="comercio-local">üìç ${comercio.local}</p>
                        <p class="comercio-horario">üïê ${comercio.horario || 'Hor√°rio n√£o informado'}</p>
                        <div class="comercio-produtos">
                            <strong>Produtos:</strong>
                            <p class="produtos-texto">${(comercio.produtos || []).join(', ')}</p>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Erro ao carregar com√©rcios:', error);
                document.getElementById('comerciosList').innerHTML = '<p class="error">Erro ao carregar com√©rcios</p>';
            }
        }

        function showToast(message, type = 'default') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.className = `toast toast-${type} active`;
            setTimeout(() => toast.classList.remove('active'), 3000);
        }
    </script>
</body>
</html>
